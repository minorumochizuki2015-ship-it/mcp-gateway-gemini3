<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MCP Gateway Suite - Audit Log</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;600;700&display=swap');

    /* Smooth page transition - prevent flash */
    html {
      background: #f9fafb;
    }

    body {
      opacity: 1;
      transition: opacity 0.08s ease-out;
    }

    body.loading {
      opacity: 0;
    }

    :root {
      --primary: #0066ff;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-900: #111827;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --radius: 8px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', 'Noto Sans JP', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--gray-50);
      color: var(--gray-900);
      line-height: 1.5;
      padding-top: 56px;
    }

    .nav {
      background: var(--gray-900);
      padding: 0 24px;
      display: flex;
      align-items: center;
      height: 56px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .nav-brand {
      color: #fff;
      font-weight: 700;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .nav-brand svg {
      width: 28px;
      height: 28px;
    }

    .nav-links {
      display: flex;
      gap: 4px;
      margin-left: 40px;
    }

    .nav-link {
      color: var(--gray-300);
      text-decoration: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.15s;
    }

    .nav-link:hover {
      color: #fff;
      background: rgba(255, 255, 255, 0.1);
    }

    .nav-link.active {
      color: #fff;
      background: var(--primary);
    }

    .nav-status {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--gray-300);
      font-size: 13px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    .page-title {
      font-size: 24px;
      font-weight: 700;
    }

    .page-subtitle {
      color: var(--gray-600);
      font-size: 14px;
      margin-top: 4px;
    }

    .filters {
      background: #fff;
      border-radius: var(--radius);
      padding: 16px 20px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--gray-200);
      margin: 24px 0 16px;
      display: flex;
      gap: 16px;
      align-items: flex-start;
      flex-wrap: wrap;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .filter-group.admin-token-group .filter-input {
      margin-bottom: 6px;
    }

    .filter-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-600);
      margin-bottom: 4px;
    }

    .filter-input,
    .filter-select {
      padding: 8px 12px;
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      font-size: 14px;
      min-width: 200px;
      background: #fff;
    }

    .admin-token-hint {
      display: block;
      font-size: 12px;
      color: var(--gray-600);
      margin-top: 6px;
    }

    .admin-token-hint a {
      color: var(--primary);
      text-decoration: none;
    }

    .admin-token-hint a:hover {
      text-decoration: underline;
    }

    .table-container {
      background: #fff;
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--gray-200);
      overflow: hidden;
    }

    table {
      border-collapse: collapse;
      width: 100%;
    }

    th {
      background: var(--gray-50);
      font-size: 12px;
      font-weight: 600;
      color: var(--gray-600);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--gray-200);
    }

    td {
      padding: 14px 16px;
      font-size: 14px;
      border-bottom: 1px solid var(--gray-100);
      vertical-align: top;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tr:hover {
      background: var(--gray-50);
    }

    /* P0-1b: Evidence ID highlight */
    tr.evidence-highlight {
      background: #fef3c7;
    }

    tr.evidence-highlight:hover {
      background: #fde68a;
    }

    .evidence-id {
      display: inline-block;
      margin-top: 4px;
      padding: 2px 6px;
      background: var(--gray-100);
      border-radius: 4px;
      font-size: 11px;
      color: var(--gray-600);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
    }

    .pill.info {
      background: #dbeafe;
      color: #1e40af;
    }

    .pill.warn {
      background: #fef3c7;
      color: #92400e;
    }

    .pill.danger {
      background: #fee2e2;
      color: #991b1b;
    }

    .muted {
      color: var(--gray-600);
      font-size: 13px;
    }

    .empty {
      padding: 18px;
      text-align: center;
      color: var(--gray-600);
    }

    tr.clickable { cursor: pointer; }
    tr.clickable:hover { background: var(--gray-50); }
    .detail-row { display: none; }
    .detail-row.open { display: table-row; }
    .detail-row td { padding: 0 16px 16px 16px; background: #fafbfc; border-bottom: 1px solid var(--gray-200); }
    .detail-grid { display: grid; grid-template-columns: 120px 1fr; gap: 6px 12px; font-size: 13px; }
    .detail-key { font-weight: 600; color: var(--gray-600); }
    .detail-val { color: var(--gray-900); word-break: break-all; }
    .detail-tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; margin: 1px 2px; }
    .detail-tag.cap { background: #ede9fe; color: #5b21b6; }
    .detail-tag.reason { background: #fef3c7; color: #92400e; }
    .decision-pill { display: inline-flex; padding: 3px 10px; border-radius: 999px; font-size: 12px; font-weight: 700; }
    .decision-pill.allow { background: #dcfce7; color: #166534; }
    .decision-pill.deny { background: #fee2e2; color: #991b1b; }
    .decision-pill.warn { background: #fef3c7; color: #92400e; }
    .expand-icon { display: inline-block; transition: transform 0.15s; font-size: 11px; margin-right: 6px; color: var(--gray-300); }
    tr.clickable.expanded .expand-icon { transform: rotate(90deg); }
    .evidence-summary { background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 6px; padding: 10px 14px; margin-top: 8px; font-size: 12px; line-height: 1.6; }
    .evidence-summary .ev-line { display: flex; gap: 8px; }
    .evidence-summary .ev-label { font-weight: 700; color: #0369a1; min-width: 90px; white-space: nowrap; }
    .evidence-summary .ev-value { color: var(--gray-900); }
    .cross-link { display: inline-flex; align-items: center; gap: 4px; margin-top: 8px; font-size: 12px; font-weight: 600; color: var(--primary); text-decoration: none; }
    .cross-link:hover { text-decoration: underline; }

    .lang-btn {
      padding: 6px 12px;
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      background: #fff;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.15s;
      color: var(--gray-700);
    }

    .lang-btn:hover {
      background: var(--gray-50);
    }

    .lang-btn.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }
  </style>
</head>

<body>
  <nav class="nav">
    <div class="nav-brand">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
      </svg>
      MCP Gateway Suite
    </div>
    <div class="nav-links">
      <a href="settings_environments.html" class="nav-link">Environments</a>
      <a href="dashboard.html" class="nav-link">Dashboard</a>
      <a href="scans.html" class="nav-link">Scans</a>
      <a href="allowlist.html" class="nav-link">AllowList</a>
      <a href="web_sandbox.html" class="nav-link">Web Sandbox</a>
      <a href="audit_log.html" class="nav-link">Audit Log</a>
    </div>
    <div class="nav-status">
      <span class="status-dot"></span>
      Gateway Online
    </div>
  </nav>

  <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
      <div>
        <h1 class="page-title" data-i18n="auditLog.title">Audit Log</h1>
        <p class="page-subtitle" data-i18n="auditLog.subtitle">Audit log of operations and decisions (read-only)</p>
        <div data-admin-session-banner-anchor="page-header"></div>
      </div>
      <div style="display: flex; gap: 4px;">
        <button type="button" class="lang-btn" id="langJa" data-lang="ja">JA</button>
        <button type="button" class="lang-btn" id="langEn" data-lang="en">EN</button>
      </div>
    </div>

    <div class="filters">
      <div class="filter-group">
        <label class="filter-label" data-i18n="auditLog.typeLabel" data-i18n-title="auditLog.typeTitle">Type</label>
        <select id="typeFilter" class="filter-select" data-i18n-title="auditLog.typeFilterTitle">
          <option value="__security__" selected>Security Decisions</option>
          <option value="">All Events</option>
          <option value="source_sink_check">MCP Block</option>
          <option value="openai_proxy_block">Proxy Block</option>
          <option value="council_decision">Council Decision</option>
          <option value="causal_web_scan">Web Scan</option>
          <option value="mcp_scan_run">Security Scan</option>
          <option value="control_upstream_updated">Upstream</option>
          <option value="token_issued">Token Issued</option>
          <option value="settings_updated">Environment</option>
        </select>
      </div>
      <div class="filter-group">
        <label class="filter-label" data-i18n="auditLog.actorLabel" data-i18n-title="auditLog.actorTitle">Actor</label>
        <input id="actorFilter" class="filter-input" data-i18n-placeholder="auditLog.actorPlaceholder"
          data-i18n-title="auditLog.actorFilterTitle" />
      </div>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Timestamp</th>
            <th>Type</th>
            <th>Actor</th>
            <th>Summary</th>
          </tr>
        </thead>
        <tbody id="auditRows"></tbody>
      </table>
      <div id="emptyBox" class="empty" hidden>No audit logs available.</div>
    </div>
  </div>

  <script src="mock_data.js"></script>
  <script src="api_client.js"></script>
  <script>
    (function () {
      if (!window.location || !window.location.pathname) return; // Skip in test/linkedom env
      const currentFile = window.location.pathname.split('/').pop() || 'audit_log.html';
      document.querySelectorAll('.nav-link').forEach(link => {
        const href = link.getAttribute('href');
        if (href === currentFile) {
          link.classList.add('active');
        } else {
          link.classList.remove('active');
        }
      });
    })();
  </script>
  <script>
    const rows = document.getElementById("auditRows");
    const emptyBox = document.getElementById("emptyBox");
    const typeSelect = document.getElementById("typeFilter");
    const actorInput = document.getElementById("actorFilter");
    const apiClient = window.apiClient || {};
    let items = [];
    let emptyMessage = window.tCommon ? window.tCommon('auditLog.emptyDefault') : "No audit logs available.";

    // P0-1b: Read evidence_id from URL query parameter
    const urlParams = new URLSearchParams(window.location.search);
    const evidenceIdFilter = urlParams.get("evidence_id") || "";

    function formatTimestamp(ts) {
      if (!ts) return "-";
      const d = new Date(ts);
      return isNaN(d.getTime())
        ? "-"
        : d.toLocaleString("en-US", { month: "short", day: "numeric", hour: "2-digit", minute: "2-digit" });
    }

    function pillType(type) {
      const t = String(type || "");
      const cls = t.includes("warn") ? "warn" : t.includes("deny") ? "danger" : "info";
      return `<span class="pill ${cls}">${t || "-"}</span>`;
    }

    const ADMIN_TYPES = ['admin_session_issued', 'control_upstream_updated', 'upstream_test', 'token_issued', 'token_revoked', 'settings_updated'];
    function render() {
      const type = typeSelect.value;
      const actor = actorInput.value.trim().toLowerCase();
      const filtered = items.filter((e) => {
        let typeOk;
        if (type === '__security__') {
          typeOk = ADMIN_TYPES.indexOf(e.type) === -1;
        } else {
          typeOk = !type || e.type === type;
        }
        const actorOk = !actor || String(e.actor || "").toLowerCase().includes(actor);
        // P0-1b: Filter by evidence_id if provided in URL
        const evidenceOk = !evidenceIdFilter || String(e.evidence_id || "").includes(evidenceIdFilter);
        return typeOk && actorOk && evidenceOk;
      });
      if (!filtered.length) {
        rows.innerHTML = "";
        emptyBox.textContent = evidenceIdFilter
          ? `No logs matching Evidence ID "${escapeHtml(evidenceIdFilter)}".`
          : emptyMessage;
        emptyBox.hidden = false;
        return;
      }
      emptyBox.hidden = true;
      const lang = window.getLanguage ? window.getLanguage() : "en";
      rows.innerHTML = filtered
        .map((e, idx) => {
          const isMatch = evidenceIdFilter && String(e.evidence_id || "").includes(evidenceIdFilter);
          const hlClass = isMatch ? ' evidence-highlight' : '';
          const evidenceCell = e.evidence_id
            ? `<code class="evidence-id" title="Evidence ID">${escapeHtml(e.evidence_id)}</code>`
            : '';
          const detail = e.detail || {};
          const hasDetail = Object.keys(detail).length > 0;
          const rowId = `audit-detail-${idx}`;
          let detailHtml = '';
          if (hasDetail) {
            const decisionVal = detail.decision || detail.reason || '';
            const decisionCls = decisionVal.includes('deny') || decisionVal.includes('block') ? 'deny' : decisionVal.includes('allow') ? 'allow' : 'warn';
            const pairs = [];
            if (detail.decision) pairs.push(['Decision', `<span class="decision-pill ${decisionCls}">${escapeHtml(detail.decision)}</span>`]);
            if (detail.reason) pairs.push([lang==='ja'?'理由':'Reason', `<span class="detail-tag reason">${escapeHtml(detail.reason)}</span>`]);
            if (detail.server_id) pairs.push(['Server ID', escapeHtml(detail.server_id)]);
            if (detail.tool_name) pairs.push([lang==='ja'?'ツール':'Tool', escapeHtml(detail.tool_name)]);
            if (detail.path) pairs.push(['Path', `<code>${escapeHtml(detail.path)}</code>`]);
            if (detail.model) pairs.push(['Model', escapeHtml(detail.model)]);
            if (detail.provider) pairs.push(['Provider', escapeHtml(detail.provider)]);
            if (detail.code) pairs.push(['Code', escapeHtml(detail.code)]);
            if (detail.http_status) pairs.push(['HTTP', escapeHtml(detail.http_status)]);
            if (detail.latency_ms) pairs.push(['Latency', detail.latency_ms + 'ms']);
            if (detail.capabilities && detail.capabilities.length) {
              pairs.push([lang==='ja'?'機能':'Capabilities', detail.capabilities.map(c => `<span class="detail-tag cap">${escapeHtml(c)}</span>`).join('')]);
            }
            if (detail.source_reasons && detail.source_reasons.length) {
              pairs.push([lang==='ja'?'検出理由':'Source Reasons', detail.source_reasons.map(r => `<span class="detail-tag reason">${escapeHtml(r)}</span>`).join('')]);
            }
            if (detail.base_url) pairs.push(['Base URL', `<code>${escapeHtml(detail.base_url)}</code>`]);
            if (detail.note) pairs.push([lang==='ja'?'メモ':'Note', escapeHtml(detail.note)]);
            // Evidence Summary (3-line template: Detection → Evidence → Action)
            const evDetection = e.summary || '-';
            const evEvidence = (detail.source_reasons || []).join(', ') || detail.reason || '-';
            const evAction = detail.decision || '-';
            const evLabels = lang === 'ja'
              ? { detection: '検知', evidence: '根拠', action: '推奨' }
              : { detection: 'Detection', evidence: 'Evidence', action: 'Action' };
            const evSummaryHtml = `<div class="evidence-summary"><div class="ev-line"><span class="ev-label">${evLabels.detection}:</span><span class="ev-value">${escapeHtml(evDetection)}</span></div><div class="ev-line"><span class="ev-label">${evLabels.evidence}:</span><span class="ev-value">${escapeHtml(evEvidence)}</span></div><div class="ev-line"><span class="ev-label">${evLabels.action}:</span><span class="ev-value"><span class="decision-pill ${decisionCls}">${escapeHtml(evAction)}</span></span></div></div>`;
            // Cross-links: type → related page
            let crossLinkHtml = '';
            if (e.type === 'causal_web_scan') {
              crossLinkHtml = `<a class="cross-link" href="web_sandbox.html">&#8594; ${lang==='ja'?'Web Sandbox で詳細を確認':'View in Web Sandbox'}</a>`;
            } else if (e.type === 'mcp_scan_run' || e.type === 'scan_run') {
              crossLinkHtml = `<a class="cross-link" href="scans.html">&#8594; ${lang==='ja'?'Scans で詳細を確認':'View in Scans'}</a>`;
            }
            detailHtml = `<tr class="detail-row" id="${rowId}"><td colspan="4"><div class="detail-grid">${pairs.map(([k,v]) => `<div class="detail-key">${k}</div><div class="detail-val">${v}</div>`).join('')}</div>${evSummaryHtml}${crossLinkHtml}</td></tr>`;
          }
          return `<tr class="${hasDetail ? 'clickable' : ''}${hlClass}" ${hasDetail ? `onclick="var d=document.getElementById('${rowId}');d.classList.toggle('open');this.classList.toggle('expanded')"` : ''}>
            <td>${hasDetail ? '<span class="expand-icon">&#9654;</span>' : ''}${formatTimestamp(e.ts)}</td>
            <td>${pillType(escapeHtml(e.type))}</td>
            <td>${escapeHtml(e.actor || "-")}</td>
            <td><div>${escapeHtml(e.summary || "-")}</div><div class="muted">${escapeHtml(e.source || "")}</div>${evidenceCell}</td>
          </tr>${detailHtml}`;
        })
        .join("");
    }

    async function refreshAudit() {
      if (!apiClient.fetchControlAudit) {
        items = [];
        render();
        return;
      }
      const res = await apiClient.fetchControlAudit(200);
      if (!res || !res.ok) {
        items = [];
        emptyMessage =
          res && res.errorType === "auth"
            ? [
              window.tCommon ? window.tCommon("auditLog.emptyNoToken") : "Please establish an admin session.",
              window.tCommon ? window.tCommon("auditLog.adminTokenHint") : "Environments → Start Session",
            ].join(" ")
            : (window.tCommon ? window.tCommon("auditLog.emptyDefault") : "No audit logs available.");
        render();
        return;
      }
      emptyMessage = window.tCommon ? window.tCommon("auditLog.emptyDefault") : "No audit logs available.";
      items = Array.isArray(res.data) ? res.data : [];
      render();
    }

    function init() {
      typeSelect.addEventListener("change", render);
      actorInput.addEventListener("input", render);
      refreshAudit();
    }

    init();
  </script>
  <script>
    // Language toggle
    const langJa = document.getElementById('langJa');
    const langEn = document.getElementById('langEn');
    function updateLangButtons() {
      const lang = window.getLanguage ? window.getLanguage() : 'en';
      if (langJa) langJa.classList.toggle('active', lang === 'ja');
      if (langEn) langEn.classList.toggle('active', lang === 'en');
    }
    if (langJa) langJa.addEventListener('click', () => {
      if (window.setLanguage) window.setLanguage('ja');
      if (window.applyCommonI18n) window.applyCommonI18n();
      updateLangButtons();
    });
    if (langEn) langEn.addEventListener('click', () => {
      if (window.setLanguage) window.setLanguage('en');
      if (window.applyCommonI18n) window.applyCommonI18n();
      updateLangButtons();
    });
    if (window.applyCommonI18n) window.applyCommonI18n();
    updateLangButtons();
  </script>
  <script>
    // Auto-detect active nav link
    (function () {
      if (!window.location || !window.location.pathname) return;
      const currentFile = window.location.pathname.split('/').pop() || 'index.html';
      document.querySelectorAll('.nav-link').forEach(link => {
        const href = link.getAttribute('href');
        if (href === currentFile) {
          link.classList.add('active');
        } else {
          link.classList.remove('active');
        }
      });
    })();
  </script>
  <script>
    // Smooth page transitions - fade out before navigating
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', function (e) {
        const href = this.getAttribute('href');
        if (href && !href.startsWith('#') && !href.startsWith('javascript')) {
          e.preventDefault();
          document.body.style.opacity = '0';
          setTimeout(() => { window.location.href = href; }, 80);
        }
      });
    });
  </script>
</body>

</html>
