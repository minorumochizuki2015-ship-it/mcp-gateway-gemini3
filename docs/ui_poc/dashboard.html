<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MCP Gateway Suite - Dashboard</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Noto+Sans+JP:wght@400;600;700&display=swap');
    html { background: #f9fafb; }
    body { opacity: 1; transition: opacity 0.08s ease-out; }
    body.loading { opacity: 0; }
    :root {
      --primary: #0066ff; --primary-dark: #0052cc;
      --success: #10b981; --warn: #f59e0b; --danger: #ef4444;
      --gray-50: #f9fafb; --gray-100: #f3f4f6; --gray-200: #e5e7eb;
      --gray-300: #d1d5db; --gray-600: #4b5563; --gray-700: #374151; --gray-900: #111827;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --radius: 12px; --bg: var(--gray-50); --card: #fff;
      --border: var(--gray-200); --text: var(--gray-900); --muted: var(--gray-600);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', 'Noto Sans JP', 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; padding-top: 56px; }
    a { color: var(--primary); text-decoration: none; }

    .nav { background: var(--gray-900); padding: 0 24px; display: flex; align-items: center; height: 56px; position: sticky; top: 0; z-index: 100; }
    .nav-brand { color: #fff; font-weight: 700; font-size: 18px; display: flex; align-items: center; gap: 10px; }
    .nav-brand svg { width: 28px; height: 28px; }
    .nav-links { display: flex; gap: 4px; margin-left: 40px; flex-wrap: wrap; }
    .nav-link { color: var(--gray-300); text-decoration: none; padding: 8px 16px; border-radius: 6px; font-size: 14px; font-weight: 500; transition: all 0.15s; }
    .nav-link:hover { color: #fff; background: rgba(255,255,255,0.1); }
    .nav-link.active { color: #fff; background: var(--primary); }
    .nav-status { margin-left: auto; display: flex; align-items: center; gap: 8px; color: var(--gray-300); font-size: 13px; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--success); animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }

    .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
    .header { margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; }
    .muted { color: var(--muted); font-size: 14px; }

    .lang-btn { padding: 6px 12px; border: 1px solid var(--gray-300); border-radius: 6px; background: #fff; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.15s; color: var(--gray-700); }
    .lang-btn:hover { background: var(--gray-50); }
    .lang-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }

    /* KPI Cards */
    .kpi-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 24px; }
    @media (max-width: 900px) { .kpi-grid { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 600px) { .kpi-grid { grid-template-columns: repeat(2, 1fr); } }
    .kpi-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow-sm); position: relative; overflow: hidden; }
    .kpi-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
    .kpi-card.blue::before { background: var(--primary); }
    .kpi-card.green::before { background: var(--success); }
    .kpi-card.red::before { background: var(--danger); }
    .kpi-card.purple::before { background: #8b5cf6; }
    .kpi-card.amber::before { background: var(--warn); }
    .kpi-label { font-size: 11px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
    .kpi-value { font-size: 28px; font-weight: 800; line-height: 1.1; }
    .kpi-sub { font-size: 12px; color: var(--muted); margin-top: 4px; }
    .kpi-value.green { color: var(--success); }
    .kpi-value.red { color: var(--danger); }
    .kpi-value.blue { color: var(--primary); }

    /* Gateway Flow */
    .flow-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 24px; box-shadow: var(--shadow-sm); margin-bottom: 24px; }
    .flow-row { display: flex; align-items: center; justify-content: center; gap: 0; padding: 16px 0; flex-wrap: wrap; }
    .flow-box { border: 2px solid var(--border); border-radius: 12px; padding: 16px 24px; text-align: center; min-width: 160px; background: #fff; position: relative; }
    .flow-box.gateway { border-color: var(--primary); background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); min-width: 220px; }
    .flow-box.gateway .flow-box-title { color: var(--primary); }
    .flow-box-title { font-weight: 700; font-size: 14px; margin-bottom: 4px; }
    .flow-box-sub { font-size: 12px; color: var(--muted); }
    .flow-box-metric { font-size: 20px; font-weight: 800; margin-top: 8px; }
    .flow-arrow { font-size: 24px; color: var(--gray-300); padding: 0 12px; flex-shrink: 0; }
    .flow-arrow.active { color: var(--primary); }
    .flow-tags { display: flex; gap: 6px; justify-content: center; margin-top: 8px; flex-wrap: wrap; }
    .flow-tag { font-size: 11px; padding: 2px 8px; border-radius: 4px; font-weight: 600; }
    .flow-tag.green { background: #d1fae5; color: #065f46; }
    .flow-tag.red { background: #fee2e2; color: #991b1b; }
    .flow-tag.amber { background: #fef3c7; color: #92400e; }

    /* Decisions Table */
    .section-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 24px; box-shadow: var(--shadow-sm); margin-bottom: 24px; }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .section-title { font-size: 16px; font-weight: 700; }
    .section-sub { font-size: 12px; color: var(--muted); }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { text-align: left; font-weight: 600; color: var(--muted); padding: 8px 12px; border-bottom: 2px solid var(--border); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }
    td { padding: 10px 12px; border-bottom: 1px solid var(--border); }
    tr:last-child td { border-bottom: none; }
    .pill { display: inline-block; padding: 3px 10px; border-radius: 10px; font-size: 11px; font-weight: 700; }
    .pill.allow { background: #d1fae5; color: #065f46; }
    .pill.deny { background: #fee2e2; color: #991b1b; }
    .pill.quarantine { background: #fef3c7; color: #92400e; }
    .pill.info { background: #dbeafe; color: #1e40af; }
    .conf-bar { width: 48px; height: 6px; background: var(--gray-200); border-radius: 3px; display: inline-block; vertical-align: middle; margin-left: 6px; overflow: hidden; }
    .conf-fill { height: 100%; border-radius: 3px; }
    .conf-fill.high { background: var(--success); }
    .conf-fill.mid { background: var(--warn); }
    .conf-fill.low { background: var(--danger); }
    .evidence-link { font-family: monospace; font-size: 11px; color: var(--primary); cursor: pointer; }
    .evidence-link:hover { text-decoration: underline; }

    /* Bottom Grid */
    .bottom-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    @media (max-width: 768px) { .bottom-grid { grid-template-columns: 1fr; } }

    .severity-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    .sev-item { text-align: center; padding: 12px 8px; background: var(--gray-50); border-radius: 8px; border: 1px solid var(--border); }
    .sev-label { font-size: 11px; font-weight: 600; color: var(--muted); text-transform: uppercase; margin-bottom: 4px; }
    .sev-value { font-size: 24px; font-weight: 800; }
    .sev-value.critical { color: #dc2626; }
    .sev-value.high { color: #ea580c; }
    .sev-value.medium { color: #f59e0b; }
    .sev-value.low { color: #22c55e; }
    .sev-bar { height: 4px; background: var(--gray-200); border-radius: 2px; margin-top: 8px; overflow: hidden; }
    .sev-fill { height: 100%; border-radius: 2px; }

    .action-btn { display: flex; align-items: center; gap: 10px; padding: 14px 16px; background: var(--gray-50); border: 1px solid var(--border); border-radius: 8px; font-size: 14px; font-weight: 600; color: var(--text); text-decoration: none; transition: all 0.15s; cursor: pointer; }
    .action-btn:hover { background: #fff; border-color: var(--primary); color: var(--primary); transform: translateX(4px); }
    .action-btn svg { width: 20px; height: 20px; flex-shrink: 0; }
    .action-btn .action-desc { font-size: 12px; font-weight: 400; color: var(--muted); }
    .actions-stack { display: flex; flex-direction: column; gap: 10px; }

    .empty-hint { text-align: center; padding: 32px 16px; color: var(--muted); font-size: 13px; }
    .empty-hint a { font-weight: 600; }
  </style>
</head>

<body>
  <nav class="nav">
    <div class="nav-brand">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" role="img" aria-label="MCP Gateway Suite">
        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
      </svg>
      MCP Gateway Suite
    </div>
    <div class="nav-links">
      <a href="settings_environments.html" class="nav-link">Environments</a>
      <a href="dashboard.html" class="nav-link">Dashboard</a>
      <a href="scans.html" class="nav-link">Scans</a>
      <a href="allowlist.html" class="nav-link">AllowList</a>
      <a href="web_sandbox.html" class="nav-link">Web Sandbox</a>
      <a href="audit_log.html" class="nav-link">Audit Log</a>
    </div>
    <div class="nav-status">
      <span class="status-dot"></span>
      Gateway Online
    </div>
  </nav>

  <div class="container">
    <div class="header">
      <div>
        <h1 id="pageTitle">AI Gateway Dashboard</h1>
        <p class="muted" id="pageSubtitle">Real-time decisions, evidence, and policy enforcement</p>
      </div>
      <div style="display: flex; align-items: center; gap: 8px;">
        <span style="font-size: 13px; color: var(--muted);">Language:</span>
        <div style="display: flex; gap: 4px;">
          <button type="button" class="lang-btn" id="langJa" data-lang="ja">JA</button>
          <button type="button" class="lang-btn" id="langEn" data-lang="en">EN</button>
        </div>
      </div>
    </div>

    <!-- KPI Cards -->
    <div class="kpi-grid">
      <div class="kpi-card blue">
        <div class="kpi-label" id="kpiTotalLabel">Total Requests</div>
        <div class="kpi-value" id="kpiTotal">0</div>
        <div class="kpi-sub" id="kpiTotalSub">MCP tool calls inspected</div>
      </div>
      <div class="kpi-card green">
        <div class="kpi-label" id="kpiAllowLabel">Allowed</div>
        <div class="kpi-value green" id="kpiAllow">0</div>
        <div class="kpi-sub" id="kpiAllowSub">passed policy checks</div>
      </div>
      <div class="kpi-card red">
        <div class="kpi-label" id="kpiBlockLabel">Block Rate</div>
        <div class="kpi-value red" id="kpiBlock">0%</div>
        <div class="kpi-sub" id="kpiBlockSub">denied or quarantined</div>
      </div>
      <div class="kpi-card purple">
        <div class="kpi-label" id="kpiCouncilLabel">AI Council</div>
        <div class="kpi-value blue" id="kpiCouncil">0</div>
        <div class="kpi-sub" id="kpiCouncilSub">Gemini-powered verdicts</div>
      </div>
      <div class="kpi-card amber">
        <div class="kpi-label" id="kpiPolicyLabel">Policy</div>
        <div class="kpi-value" id="kpiPolicy" style="font-size: 18px;">-</div>
        <div class="kpi-sub" id="kpiPolicySub">bundle status</div>
      </div>
    </div>

    <!-- Gateway Flow Diagram -->
    <div class="flow-card">
      <div class="flow-row">
        <div class="flow-box">
          <div class="flow-box-title" id="flowAgentTitle">Agent Requests</div>
          <div class="flow-box-sub" id="flowAgentSub">MCP Clients</div>
          <div class="flow-box-metric" id="flowAgentMetric">0</div>
        </div>
        <div class="flow-arrow active">&#10132;</div>
        <div class="flow-box gateway">
          <div class="flow-box-title" id="flowGatewayTitle">MCP Gateway</div>
          <div class="flow-box-sub">Auth &middot; Inspect &middot; Route</div>
          <div class="flow-tags" style="margin-top: 12px;">
            <span class="flow-tag green" id="flowGeminiTag">Gemini 3</span>
            <span class="flow-tag amber" id="flowPolicyTag">Policy Engine</span>
          </div>
        </div>
        <div class="flow-arrow active">&#10132;</div>
        <div class="flow-box">
          <div class="flow-box-title" id="flowToolsTitle">AI Tools & APIs</div>
          <div class="flow-box-sub" id="flowToolsSub">Upstream LLM</div>
          <div class="flow-tags" style="margin-top: 10px;">
            <span class="flow-tag green" id="flowAllowed">0 Allowed</span>
            <span class="flow-tag red" id="flowBlocked">0 Blocked</span>
            <span class="flow-tag amber" id="flowQuarantined">0 Quarantined</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Decisions -->
    <div class="section-card">
      <div class="section-header">
        <div>
          <div class="section-title" id="decisionsTitle">Recent Decisions</div>
          <div class="section-sub" id="decisionsSub">AI Council verdicts and policy enforcement actions</div>
        </div>
        <a href="audit_log.html" style="font-size: 13px; font-weight: 600;" id="viewAllLink">View all &rarr;</a>
      </div>
      <table id="decisionsTable">
        <thead id="decisionsThead">
          <tr><th>Time</th><th>Decision</th><th>Confidence</th><th>Finding</th><th>Evidence</th></tr>
        </thead>
        <tbody id="decisionsBody"></tbody>
      </table>
      <div class="empty-hint" id="decisionsEmpty">
        No decisions yet. <a href="web_sandbox.html">Run your first scan</a> to see AI-powered verdicts here.
      </div>
    </div>

    <!-- Bottom Grid: Severity + Quick Actions -->
    <div class="bottom-grid">
      <div class="section-card">
        <div class="section-title" id="severityTitle" style="margin-bottom: 16px;">Severity Breakdown</div>
        <div class="severity-grid">
          <div class="sev-item"><div class="sev-label">Critical</div><div class="sev-value critical" id="sevCritical">0</div><div class="sev-bar"><div class="sev-fill" id="sevCriticalBar" style="width:0%;background:#dc2626;"></div></div></div>
          <div class="sev-item"><div class="sev-label">High</div><div class="sev-value high" id="sevHigh">0</div><div class="sev-bar"><div class="sev-fill" id="sevHighBar" style="width:0%;background:#ea580c;"></div></div></div>
          <div class="sev-item"><div class="sev-label">Medium</div><div class="sev-value medium" id="sevMedium">0</div><div class="sev-bar"><div class="sev-fill" id="sevMediumBar" style="width:0%;background:#f59e0b;"></div></div></div>
          <div class="sev-item"><div class="sev-label">Low</div><div class="sev-value low" id="sevLow">0</div><div class="sev-bar"><div class="sev-fill" id="sevLowBar" style="width:0%;background:#22c55e;"></div></div></div>
        </div>
      </div>
      <div class="section-card">
        <div class="section-title" id="actionsTitle" style="margin-bottom: 16px;">Quick Actions</div>
        <div class="actions-stack">
          <a href="web_sandbox.html" class="action-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/></svg>
            <div><div id="actionScan">Scan a URL</div><div class="action-desc" id="actionScanDesc">Analyze a web page with Causal Web Sandbox</div></div>
          </a>
          <a href="audit_log.html" class="action-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
            <div><div id="actionAudit">View Evidence Trail</div><div class="action-desc" id="actionAuditDesc">Browse structured audit log with evidence IDs</div></div>
          </a>
          <a href="settings_environments.html" class="action-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><circle cx="12" cy="12" r="3"/></svg>
            <div><div id="actionPolicy">Configure Policies</div><div class="action-desc" id="actionPolicyDesc">Manage upstream LLM and policy profiles</div></div>
          </a>
        </div>
      </div>
    </div>
  </div>

  <script src="api_client.js"></script>
  <script>
    (function () {
      if (!window.location || !window.location.pathname) return;
      const currentFile = window.location.pathname.split('/').pop() || 'dashboard.html';
      document.querySelectorAll('.nav-link').forEach(link => {
        const href = link.getAttribute('href');
        if (href === currentFile || (currentFile === '' && href === 'dashboard.html')) link.classList.add('active');
        else link.classList.remove('active');
      });
    })();
  </script>
  <script>
    function escapeHtml(str) { if (str == null) return ''; return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

    const I18N = {
      en: {
        pageTitle: 'AI Gateway Dashboard',
        pageSubtitle: 'Real-time decisions, evidence, and policy enforcement',
        kpiTotal: 'Total Requests', kpiTotalSub: 'MCP tool calls inspected',
        kpiAllow: 'Allowed', kpiAllowSub: 'passed policy checks',
        kpiBlock: 'Block Rate', kpiBlockSub: 'denied or quarantined',
        kpiCouncil: 'AI Council', kpiCouncilSub: 'Gemini-powered verdicts',
        kpiPolicy: 'Policy', kpiPolicySub: 'bundle status',
        flowAgent: 'Agent Requests', flowAgentSub: 'MCP Clients',
        flowGateway: 'MCP Gateway', flowTools: 'AI Tools & APIs', flowToolsSub: 'Upstream LLM',
        flowAllowed: 'Allowed', flowBlocked: 'Blocked', flowQuarantined: 'Quarantined',
        decisionsTitle: 'Recent Decisions', decisionsSub: 'AI Council verdicts and policy enforcement actions',
        viewAll: 'View all', thTime: 'Time', thDecision: 'Decision', thConfidence: 'Confidence', thFinding: 'Finding', thEvidence: 'Evidence',
        decisionsEmpty: 'No decisions yet.', decisionsEmptyLink: 'Run your first scan',
        decisionsEmptyTail: ' to see AI-powered verdicts here.',
        severityTitle: 'Severity Breakdown', actionsTitle: 'Quick Actions',
        actionScan: 'Scan a URL', actionScanDesc: 'Analyze a web page with Causal Web Sandbox',
        actionAudit: 'View Evidence Trail', actionAuditDesc: 'Browse structured audit log with evidence IDs',
        actionPolicy: 'Configure Policies', actionPolicyDesc: 'Manage upstream LLM and policy profiles',
        policyVerified: 'Verified', policyPresent: 'Present', policyMissing: 'Missing', policyNA: 'N/A',
      },
      ja: {
        pageTitle: 'AI ゲートウェイ ダッシュボード',
        pageSubtitle: 'リアルタイムの判定・証跡・ポリシー適用',
        kpiTotal: '総リクエスト', kpiTotalSub: '検査済み MCP ツール呼び出し',
        kpiAllow: '許可', kpiAllowSub: 'ポリシーチェック通過',
        kpiBlock: 'ブロック率', kpiBlockSub: '拒否またはクォランティン',
        kpiCouncil: 'AI Council', kpiCouncilSub: 'Gemini 構造化判定',
        kpiPolicy: 'ポリシー', kpiPolicySub: 'バンドル状態',
        flowAgent: 'エージェント要求', flowAgentSub: 'MCP クライアント',
        flowGateway: 'MCP ゲートウェイ', flowTools: 'AI ツール & API', flowToolsSub: 'アップストリーム LLM',
        flowAllowed: '許可', flowBlocked: 'ブロック', flowQuarantined: '隔離',
        decisionsTitle: '最近の判定', decisionsSub: 'AI Council 判定とポリシー適用アクション',
        viewAll: 'すべて表示', thTime: '時刻', thDecision: '判定', thConfidence: '信頼度', thFinding: '検出内容', thEvidence: '証跡',
        decisionsEmpty: '判定はまだありません。', decisionsEmptyLink: '最初のスキャンを実行',
        decisionsEmptyTail: 'して、AIによる判定を確認してください。',
        severityTitle: '深刻度内訳', actionsTitle: 'クイックアクション',
        actionScan: 'URL をスキャン', actionScanDesc: 'Causal Web Sandbox でページを分析',
        actionAudit: '証跡トレイルを表示', actionAuditDesc: '構造化された監査ログと証跡 ID を閲覧',
        actionPolicy: 'ポリシーを設定', actionPolicyDesc: 'アップストリーム LLM とポリシープロファイルを管理',
        policyVerified: '検証済', policyPresent: '存在', policyMissing: '未設定', policyNA: 'N/A',
      }
    };

    const LANG_KEY = 'suite_language';
    function getLang() { try { return localStorage.getItem(LANG_KEY) || 'en'; } catch(e) { return 'en'; } }
    function setLang(l) { try { localStorage.setItem(LANG_KEY, l); } catch(e) {} }

    function applyI18n(lang) {
      var d = I18N[lang] || I18N.en;
      var el = function(id) { return document.getElementById(id); };
      if (el('pageTitle')) el('pageTitle').textContent = d.pageTitle;
      if (el('pageSubtitle')) el('pageSubtitle').textContent = d.pageSubtitle;
      if (el('kpiTotalLabel')) el('kpiTotalLabel').textContent = d.kpiTotal;
      if (el('kpiTotalSub')) el('kpiTotalSub').textContent = d.kpiTotalSub;
      if (el('kpiAllowLabel')) el('kpiAllowLabel').textContent = d.kpiAllow;
      if (el('kpiAllowSub')) el('kpiAllowSub').textContent = d.kpiAllowSub;
      if (el('kpiBlockLabel')) el('kpiBlockLabel').textContent = d.kpiBlock;
      if (el('kpiBlockSub')) el('kpiBlockSub').textContent = d.kpiBlockSub;
      if (el('kpiCouncilLabel')) el('kpiCouncilLabel').textContent = d.kpiCouncil;
      if (el('kpiCouncilSub')) el('kpiCouncilSub').textContent = d.kpiCouncilSub;
      if (el('kpiPolicyLabel')) el('kpiPolicyLabel').textContent = d.kpiPolicy;
      if (el('kpiPolicySub')) el('kpiPolicySub').textContent = d.kpiPolicySub;
      if (el('flowAgentTitle')) el('flowAgentTitle').textContent = d.flowAgent;
      if (el('flowAgentSub')) el('flowAgentSub').textContent = d.flowAgentSub;
      if (el('flowGatewayTitle')) el('flowGatewayTitle').textContent = d.flowGateway;
      if (el('flowToolsTitle')) el('flowToolsTitle').textContent = d.flowTools;
      if (el('flowToolsSub')) el('flowToolsSub').textContent = d.flowToolsSub;
      if (el('decisionsTitle')) el('decisionsTitle').textContent = d.decisionsTitle;
      if (el('decisionsSub')) el('decisionsSub').textContent = d.decisionsSub;
      if (el('viewAllLink')) el('viewAllLink').innerHTML = escapeHtml(d.viewAll) + ' &rarr;';
      if (el('severityTitle')) el('severityTitle').textContent = d.severityTitle;
      if (el('actionsTitle')) el('actionsTitle').textContent = d.actionsTitle;
      if (el('actionScan')) el('actionScan').textContent = d.actionScan;
      if (el('actionScanDesc')) el('actionScanDesc').textContent = d.actionScanDesc;
      if (el('actionAudit')) el('actionAudit').textContent = d.actionAudit;
      if (el('actionAuditDesc')) el('actionAuditDesc').textContent = d.actionAuditDesc;
      if (el('actionPolicy')) el('actionPolicy').textContent = d.actionPolicy;
      if (el('actionPolicyDesc')) el('actionPolicyDesc').textContent = d.actionPolicyDesc;
      var th = el('decisionsThead');
      if (th) th.innerHTML = '<tr><th>' + [d.thTime, d.thDecision, d.thConfidence, d.thFinding, d.thEvidence].map(escapeHtml).join('</th><th>') + '</th></tr>';
      if (el('decisionsEmpty')) el('decisionsEmpty').innerHTML = escapeHtml(d.decisionsEmpty) + ' <a href="web_sandbox.html">' + escapeHtml(d.decisionsEmptyLink) + '</a>' + escapeHtml(d.decisionsEmptyTail);
      // lang buttons
      var ja = el('langJa'), en = el('langEn');
      if (ja) ja.classList.toggle('active', lang === 'ja');
      if (en) en.classList.toggle('active', lang === 'en');
    }

    function decisionPill(type) {
      var t = String(type || '').toLowerCase();
      if (t.includes('deny') || t.includes('block')) return '<span class="pill deny">DENY</span>';
      if (t.includes('quarantine') || t.includes('warn')) return '<span class="pill quarantine">QUARANTINE</span>';
      return '<span class="pill allow">ALLOW</span>';
    }

    function confBar(val) {
      var pct = typeof val === 'number' ? Math.round(val * 100) : (parseInt(val) || 0);
      var cls = pct >= 70 ? 'high' : pct >= 40 ? 'mid' : 'low';
      return pct + '%<div class="conf-bar"><div class="conf-fill ' + cls + '" style="width:' + pct + '%;"></div></div>';
    }

    function formatTs(ts) {
      if (!ts) return '-';
      try { var d = new Date(ts); return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); } catch(e) { return ts; }
    }

    function getPolicyStatus(shadow, allowlistStatus) {
      var d = I18N[getLang()] || I18N.en;
      var source = allowlistStatus || shadow || {};
      var sig = String(source.policy_bundle_signature_status || '');
      if (sig.startsWith('verified')) return { text: d.policyVerified, cls: 'green' };
      var present = source.policy_bundle_present_ok;
      if (present === true) return { text: d.policyPresent, cls: 'blue' };
      if (present === false) return { text: d.policyMissing, cls: 'red' };
      return { text: d.policyNA, cls: '' };
    }

    async function init() {
      var apiClient = window.apiClient;
      if (!apiClient) return;
      var lang = getLang();
      var d = I18N[lang] || I18N.en;

      // Fetch data in parallel
      var summaryP = apiClient.fetchDashboardSummary ? apiClient.fetchDashboardSummary() : Promise.resolve(null);
      var allowStatusP = apiClient.fetchAllowlistStatus ? apiClient.fetchAllowlistStatus() : Promise.resolve(null);
      var auditP = apiClient.fetchControlAudit ? apiClient.fetchControlAudit(10) : Promise.resolve(null);
      var webVerdictsP = apiClient.fetchWebSandboxVerdicts ? apiClient.fetchWebSandboxVerdicts() : Promise.resolve(null);

      var results = await Promise.all([summaryP, allowStatusP, auditP, webVerdictsP]);
      var summary = results[0];
      var allowlistStatus = results[1];
      var auditRes = results[2];
      var webVerdicts = results[3];

      // KPI Cards
      var allow = (summary && summary.allowlist) || {};
      var scans = (summary && summary.scans) || {};
      var council = (summary && summary.council) || {};
      var total = (allow.total || 0) + (scans.total || 0) + (council.total || 0);
      var denied = (allow.deny || 0) + (allow.quarantine || 0);
      var allowed = (allow.active || 0);
      var blockRate = total > 0 ? ((denied / total) * 100).toFixed(1) : '0';

      document.getElementById('kpiTotal').textContent = total;
      document.getElementById('kpiAllow').textContent = allowed;
      document.getElementById('kpiBlock').textContent = blockRate + '%';
      document.getElementById('kpiCouncil').textContent = council.total || 0;

      // Policy status
      var policyStatus = getPolicyStatus(summary && summary.shadow_audit, allowlistStatus);
      var policyEl = document.getElementById('kpiPolicy');
      policyEl.textContent = policyStatus.text;
      if (policyStatus.cls) policyEl.className = 'kpi-value ' + policyStatus.cls;

      // Flow diagram
      document.getElementById('flowAgentMetric').textContent = total;
      document.getElementById('flowAllowed').textContent = allowed + ' ' + d.flowAllowed;
      document.getElementById('flowBlocked').textContent = (allow.deny || 0) + ' ' + d.flowBlocked;
      document.getElementById('flowQuarantined').textContent = (allow.quarantine || 0) + ' ' + d.flowQuarantined;

      // Severity
      var sev = scans.severity_counts || {};
      var sevTotal = (sev.critical || 0) + (sev.high || 0) + (sev.medium || 0) + (sev.low || 0) || 1;
      document.getElementById('sevCritical').textContent = sev.critical || 0;
      document.getElementById('sevHigh').textContent = sev.high || 0;
      document.getElementById('sevMedium').textContent = sev.medium || 0;
      document.getElementById('sevLow').textContent = sev.low || 0;
      document.getElementById('sevCriticalBar').style.width = ((sev.critical || 0) / sevTotal * 100) + '%';
      document.getElementById('sevHighBar').style.width = ((sev.high || 0) / sevTotal * 100) + '%';
      document.getElementById('sevMediumBar').style.width = ((sev.medium || 0) / sevTotal * 100) + '%';
      document.getElementById('sevLowBar').style.width = ((sev.low || 0) / sevTotal * 100) + '%';

      // Recent Decisions - combine audit + web sandbox verdicts
      // Filter: only show security-relevant events (deny/block/scan/council), not admin management events
      var SECURITY_EVENTS = ['source_sink_check', 'openai_proxy_block', 'council_decision', 'mcp_scan_run', 'causal_web_scan', 'semantic_scan', 'redteam_gemini'];
      var ADMIN_EVENTS = ['admin_session_issued', 'control_upstream_updated', 'upstream_test', 'token_issued', 'token_revoked', 'settings_updated'];
      var decisions = [];
      // From audit log - security events only
      if (auditRes && auditRes.ok && Array.isArray(auditRes.data)) {
        auditRes.data.filter(function(e) {
          var t = String(e.type || '');
          // Include: explicit security events, deny decisions, block events
          // Exclude: admin management events
          return ADMIN_EVENTS.indexOf(t) === -1;
        }).slice(0, 8).forEach(function(e) {
          var dec = 'allow';
          if (e.summary && (e.summary.indexOf('blocked') >= 0 || e.summary.indexOf('deny') >= 0)) dec = 'deny';
          else if (e.summary && e.summary.indexOf('quarantine') >= 0) dec = 'quarantine';
          else if (e.type && e.type.indexOf('block') >= 0) dec = 'deny';
          decisions.push({
            ts: e.ts,
            decision: dec,
            confidence: null,
            finding: e.summary || '-',
            evidence_id: e.evidence_id || '',
          });
        });
      }
      // From web sandbox verdicts
      var wv = (webVerdicts && webVerdicts.verdicts) || [];
      wv.slice().reverse().slice(0, 5).forEach(function(v) {
        decisions.push({
          ts: v.timestamp,
          decision: v.recommended_action === 'block' ? 'deny' : v.recommended_action === 'warn' ? 'quarantine' : 'allow',
          confidence: v.confidence,
          finding: v.classification + (v.summary ? ': ' + v.summary.slice(0, 60) : ''),
          evidence_id: v.run_id || '',
        });
      });
      // Sort by timestamp desc
      decisions.sort(function(a, b) { return (b.ts || '') > (a.ts || '') ? 1 : -1; });
      decisions = decisions.slice(0, 10);

      var tbody = document.getElementById('decisionsBody');
      var emptyEl = document.getElementById('decisionsEmpty');
      var tableEl = document.getElementById('decisionsTable');
      if (decisions.length > 0) {
        tbody.innerHTML = decisions.map(function(dec) {
          var evidenceHtml = dec.evidence_id
            ? '<a class="evidence-link" href="audit_log.html?evidence_id=' + encodeURIComponent(dec.evidence_id) + '">' + escapeHtml(String(dec.evidence_id).slice(0, 12)) + '...</a>'
            : '-';
          var confHtml = dec.confidence != null ? confBar(dec.confidence) : '<span class="muted">-</span>';
          return '<tr><td style="white-space:nowrap;font-size:12px;">' + escapeHtml(formatTs(dec.ts)) + '</td><td>' + decisionPill(dec.decision) + '</td><td>' + confHtml + '</td><td style="max-width:280px;overflow:hidden;text-overflow:ellipsis;">' + escapeHtml(dec.finding) + '</td><td>' + evidenceHtml + '</td></tr>';
        }).join('');
        tableEl.style.display = '';
        emptyEl.style.display = 'none';
      } else {
        tableEl.style.display = 'none';
        emptyEl.style.display = '';
      }
    }

    // Language toggle
    var langJa = document.getElementById('langJa');
    var langEn = document.getElementById('langEn');
    if (langJa) langJa.addEventListener('click', function() { setLang('ja'); applyI18n('ja'); init(); });
    if (langEn) langEn.addEventListener('click', function() { setLang('en'); applyI18n('en'); init(); });

    applyI18n(getLang());
    init();
  </script>
  <script>
    document.querySelectorAll('.nav-link').forEach(function(link) {
      link.addEventListener('click', function(e) {
        var href = this.getAttribute('href');
        if (href && !href.startsWith('#') && !href.startsWith('javascript')) {
          e.preventDefault();
          document.body.style.opacity = '0';
          setTimeout(function() { window.location.href = href; }, 80);
        }
      });
    });
  </script>
</body>

</html>
